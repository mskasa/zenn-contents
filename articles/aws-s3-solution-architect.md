---
title: "AWS SAP対策 S3編"
emoji: "✏️"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [aws, s3]
published: false
---

## 概要
AWS 認定試験SAP

## S3ストレージクラス早見表
| ストレージクラス                             | アクセス頻度 | データ取得時間 | データの重要度 | 
| -------------------------------------------- | ------------ | -------------- | ------ | 
| 標準（Standard）                             | 高い         | ミリ秒         | 高い   | 
| 標準-低頻度アクセス（Standard-IA）           | 低い         | ミリ秒         | 高い   | 
| 1ゾーン-低頻度アクセス（One Zone-IA）        | 低い         | ミリ秒         | 低い   | 
| Intelligent-Tiering                          | 変動する     | ミリ秒         | 高い   | 
| Glacier Instant Retrieval                    | ほぼない     | ミリ秒         | 高い   | 
| Glacier Flexible Retrieval（旧 S3 Glacier）  | ほぼない     | 1分〜12時間    | 高い   | 
| Glacier Deep Archive                         | ほぼない     | 12〜48 時間    | 高い   | 

https://aws.amazon.com/jp/s3/storage-classes/

:::message
* 保存するデータの重要度が「低い」場合は1ゾーン一択
* アクセス頻度は標準、IA、Glacierの3段階
:::

### S3データ取得オプション
Glacierでよく出題されるので、細かな数字まで覚えておくと安心。
ミリ秒単位を要求される場合は Instant Retrieval を選択する。

| ストレージクラス              | Expedited(迅速) | Standard    | Bulk(一括) | 
| ----------------------------- | --------------- | ----------- | ------------ | 
| Glacier Flexible Retrieval（旧 S3 Glacier） | 1～5 分         | 3～5 時間   | 5～12 時間   | 
| S3 Glacier Deep Archive       | 利用不可        | 12 時間以内 | 48 時間以内  | 

:::message
* アーカイブ用途なので、一時ファイルの保管場所先としては不適切
* バックアップの保管場所先としては、RTOを満たすかどうかで判断する
:::

## S3の料金
S3の料金は、下記で構成される。

`1年間のストレージ料金 + リクエスト料金 + データ取り出し料金 + データ転送料金`

S3のクラスによって、データ転送料金以外の3つの単価が異なるため、データ特性にあったストレージクラスを選ぶことがコスト削減につながる。

https://aws.amazon.com/jp/s3/pricing/

### Intelligent-Tiering
Intelligent-Tieringは、アクセス頻度によって、オブジェクトを自動で階層分けしてくれるストレージクラス。
30日間リクエストのないオブジェクトが自動で低頻度アクセス階層へ移動する。逆に、リクエストがあると、高頻度アクセス階層へ移動する。
つまり、アクセス頻度が変化する場合や、予測できない場合にコスト効率がよくなる可能性がある。

:::message
別途、モニタリングコストとしてオブジェクト 1,000 件あたり 0.0025USD 発生する。試験で問われることは恐らく無いが、実務でS3のクラス選択をする際には念頭に置いておく。
:::

### S3リクエスタ支払い
S3料金のうち、リクエスト料金とデータ転送料金をリクエストした側のアカウントに請求する設定のこと。有効にした場合、AWSアカウント以外からのアクセスができなくなる。
リクエストする側は、課金されることを了承している旨を示すため、リクエストのヘッダーに`x-amz-request-payer`を含める必要がある。

## レプリケーション
異なるアカウント、異なるリージョンにもレプリケート（自動・非同期的にコピー）できる。

### S3 Replication Time Control (S3 RTC)
有効化することで、ほとんどのオブジェクトは数秒、99.99%のオブジェクトは15分以内にレプリケートされる。15分の閾値を超えた場合と、15分の閾値経過後にレプリケートされたオブジェクトのイベント通知を作成できる。

## パフォーマンス

### マルチパートアップロード
マルチパートアップロードはAPIとして提供されており、オブジェクトを複数のパートに分けて並列アップロードできる。スループットの向上、アップロードの一時停止・再開ができる、などのメリットがある。

そもそも、S3では、アップロード方法によって、扱えるサイズは決まっている。
https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/userguide/upload-objects.html

そのため、例えば、CLIで巨大なサイズのファイルをアップロードしようとした場合、裏では勝手にマルチアップロードが実行されている。なので、利用自体は無料（データ転送料金はもちろん発生する）。

料金という観点では、アップロードが完了せずに不完全な状態で残ってしまった場合でも、ストレージ料金の対象になってしまうという問題がある。しかし、これはライフサイクルポリシーで自動削除の設定をすることで簡単に対処できる。

### S3 Transfer Acceleration
有効にすることで、全世界のエッジロケーション経由でデータ転送ができる。
S3バケットを利用するアプリケーション側では、Transfer Acceleration専用のエンドポイントを指定する。

## 暗号化
すべてのバケットに対して、基本レベルの暗号化として、Amazon S3 マネージドキーによるサーバー側の暗号化 (SSE-S3) が適用される。
SSE-S3暗号化では、各S3オブジェクトが、強力な多要素暗号化を使用する一意のデータキーで暗号化される。
:::message
SSE-S3暗号化では、オブジェクトデータのみが暗号化される（オブジェクトのメタデータは対象外）
:::
https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/userguide/UsingServerSideEncryption.html

## ネットワーク

VPCエンドポイントを利用してアクセスする。
VPCエンドポイントには下記の2種類が存在し、それぞれS3に対応している。
* ゲートウェイエンドポイント
  * 無料
  * オンプレミスや別リージョンからのアクセスは不可
* インターフェイスエンドポイント（AWS PrivateLink）
  * 有料
  * オンプレミスや別リージョンからのアクセスが可能

よって、同一VPC内からのアクセスであれば無料のゲートウェイエンドポイント、オンプレミスや別リージョンからのアクセスの場合、インターフェイスエンドポイントを利用する。

:::message
ゲートウェイエンドポイントと同一のVPCにプロキシとして立てたEC2を経由することで、オンプレミスや別リージョンからアクセスすることも一応可能ではある。
ただし、EC2そのものの稼働コストや、構築・保守にかかるコスト等を考えると良い選択ではない。素直にシンプルかつ管理不要なインターフェイスエンドポイントを利用した方がよいだろう。
:::

## S3バッチオペレーション

|   オペレーション              |                  補足内容                  | 
| ------------------------------------------------------------ | -------------------------------------------- | 
| オブジェクトのコピー                                         | 異なるリージョンのバケットにもコピー可能     | 
| Lambda関数のコール                                           |                                              | 
| オブジェクトのすべてのタグの置換                             | すべてが対象なので、既存のタグは保持されない | 
| オブジェクトのすべてのタグの削除                             |                                              | 
| アクセスコントロールリスト[^1]の置換                      |                                              | 
| オブジェクトの復元                                           | Glacier にアーカイブされたオブジェクトの復元 | 
| オブジェクトロック[^2]の保持                                     |               保持期間を一括設定            | 
| オブジェクトロックのリーガルホールド[^3] |         有効化・解除の一括設定               | 

:::message
* どれも「すべて」や「一括」であることがポイント
* 「一部の」は不可
:::

[^1]: ACLは使わず、バケットポリシーやパブリックアクセスブロックでアクセス制御する形が一般的
[^2]: 削除または上書きを防止する機能
[^3]: 無期限のロック
