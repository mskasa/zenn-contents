---
title: "AWS SAP対策 S3編"
emoji: "✏️"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [aws, s3]
published: false
---

## S3ストレージクラス早見表

| ストレージクラス                             | アクセス頻度 | データ取得時間 | データの重要度 | 
| -------------------------------------------- | ------------ | -------------- | ------ | 
| 標準（Standard）                             | 高い         | ミリ秒         | 高い   | 
| 標準-低頻度アクセス（Standard-IA）           | 低い         | ミリ秒         | 高い   | 
| 1ゾーン-低頻度アクセス（One Zone-IA）        | 低い         | ミリ秒         | 低い   | 
| Intelligent-Tiering                          | 変動する     | ミリ秒         | 高い   | 
| Glacier Instant Retrieval                    | ほぼない     | ミリ秒         | 高い   | 
| Glacier Flexible Retrieval（旧 S3 Glacier）  | ほぼない     | 1分〜12時間    | 高い   | 
| Glacier Deep Archive                         | ほぼない     | 12〜48 時間    | 高い   | 

https://aws.amazon.com/jp/s3/storage-classes/

:::message
* 保存するデータの重要度が「低い」場合は1ゾーン一択
* アクセス頻度は標準、IA、Glacierの3段階
* Glacierはデータ取得時間で3つのタイプに分かれる（細かな数字も覚えておく）
* Intelligent-Tieringについては後述する
:::

### S3データ取得オプション

Glacierでよく出題されるので、細かな数字まで覚えておくと安心。
ミリ秒単位を要求される場合は Instant Retrieval を選択する。

| ストレージクラス              | Expedited(迅速) | Standard    | Bulk(一括) | 
| ----------------------------- | --------------- | ----------- | ------------ | 
| Glacier Flexible Retrieval（旧 S3 Glacier） | 1～5 分         | 3～5 時間   | 5～12 時間   | 
| S3 Glacier Deep Archive       | 利用不可        | 12 時間以内 | 48 時間以内  | 

## S3の料金

S3の料金は、下記で構成される。

1年間のストレージ料金 + リクエスト料金 + データ取り出し料金 + データ転送料金

S3のクラスによって、3要素の単価が異なるため、データ特性にあったストレージクラスを選ぶことがコスト削減につながる。

:::message
データ転送料金はS3のクラスによって変動しないため、試験で取り上げられることはないはず
:::

https://aws.amazon.com/jp/s3/pricing/

### Intelligent-Tiering

Intelligent-Tieringは、アクセス頻度によって、オブジェクトを自動で階層分けしてくれるストレージクラス。
30日間リクエストのないオブジェクトが自動で、低頻度アクセス階層へ移動する。逆に、リクエストがあると、高頻度アクセス階層へ移動する。
つまり、アクセス頻度が変化する場合や、予測できない場合にコスト効率がよくなる可能性がある。

:::message
* 別途、モニタリングコストとしてオブジェクト 1,000 件あたり 0.0025USD 発生する
  * 試験で問われることは恐らく無いが、実務でS3のクラス選択をする際には念頭に置いておく
:::

### S3リクエスタ支払い

S3料金のうち、リクエスト料金とデータ転送料金をリクエストした側のアカウントに請求する設定のこと。
有効にした場合、AWSアカウント以外からのアクセスができなくなる。
リクエストする側は、課金されることを了承している旨を示すため、リクエストのヘッダーに`x-amz-request-payer`を含める必要がある。

## レプリケーション

異なるアカウント、異なるリージョンにもレプリケート（自動・非同期的にコピー）できる。

### S3 Replication Time Control (S3 RTC)

有効化することで、ほとんどのオブジェクトは数秒、99.99%のオブジェクトは15分以内にレプリケートされる。
15分の閾値を超えた場合と、15分の閾値経過後にレプリケートされたオブジェクトのイベント通知を作成できる。

## パフォーマンス

### マルチパートアップロード

マルチパートアップロードはAPIとして提供されており、オブジェクトを複数のパートに分けて並列アップロードできる。スループットの向上、アップロードの一時停止・再開ができる、などのメリットがある。

そもそも、S3では、アップロード方法によって、扱えるサイズは決まっている。
https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/userguide/upload-objects.html

そのため、例えば、CLIで巨大なサイズのファイルをアップロードしようとした場合、勝手に裏でマルチアップロードが実行されている。なので、利用自体は無料（データ転送料金はもちろん発生する）。

料金という観点では、アップロードが完了せずに不完全な状態で残ってしまった場合でも、ストレージ料金の対象になってしまうという問題がある。しかし、これはライフサイクルポリシーで自動削除の設定をすることで簡単に対処できる。

### S3 Transfer Acceleration

有効にすることで、全世界のエッジロケーション経由でデータ転送ができる。
S3バケットを利用するアプリケーション側では、Transfer Acceleration専用のエンドポイントを指定する。
