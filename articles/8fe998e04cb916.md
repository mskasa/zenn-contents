---
title: "Terraformã®å‹ã¨ãƒ«ãƒ¼ãƒ—å‡¦ç†ã‚’ç†è§£ã™ã‚‹"
emoji: "ğŸ‰"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [terraform]
published: false
---

## æœ¬è¨˜äº‹ã®ç›®çš„
* Terraformã®å‹ã«ã¤ã„ã¦æ•´ç†ã™ã‚‹
* ãªã‚“ã¨ãªãæ›¸ã„ã¦ã„ã‚‹Terraformã®ãƒ«ãƒ¼ãƒ—å‡¦ç†ã‚’ç†è§£ã™ã‚‹
* Terraformã®ãƒ«ãƒ¼ãƒ—å‡¦ç†ã®ä½¿ã„æ‰€ã€ä½¿ã„åˆ†ã‘ã«ã¤ã„ã¦ç†è§£ã™ã‚‹

Terraformã®ç¹°ã‚Šè¿”ã—å‡¦ç†ã¯å¯èª­æ€§ãŒã‚¤ãƒã‚¤ãƒã§ã€ã‚³ãƒ”ãƒšã§ä¹—ã‚Šè¶Šãˆã¦ã„ã‚‹äººã‚‚å¤šã„ã‹ã¨æ€ã„ã¾ã™ã€‚æœ¬è¨˜äº‹ã‚’èª­ã‚ã°ã€ãã®çŠ¶æ…‹ã‚’è„±å´ã§ãã‚‹ã¯ãšã§ã™ã€‚Terraformã‚’DRYã«æ›¸ããŸã‚ã«å¿…é ˆã®ã‚¹ã‚­ãƒ«ãªã®ã§ãœã²ä¸€èª­ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

## Terraformã®å‹ã«ã¤ã„ã¦

å‹ã«ã¤ã„ã¦ã®ç†è§£ãŒä¸ååˆ†ã§ã‚ã‚‹å ´åˆã€ãƒ«ãƒ¼ãƒ—å‡¦ç†ã®ç†è§£ãŒé›£ã—ããªã‚Šã¾ã™ã€‚
å‰æçŸ¥è­˜ã¨ã—ã¦çŸ¥ã£ã¦ãŠãå¿…è¦ãŒã‚ã‚‹ãŸã‚ã€ã–ã£ãã‚Šã¨èª¬æ˜ã—ã¾ã™ã€‚
ã‚‚ã¡ã‚ã‚“ã€çŸ¥ã£ã¦ã„ã‚‹æ–¹ã¯èª­ã¿é£›ã°ã—ã¦ã‚‚ã‚‰ã£ã¦çµæ§‹ã§ã™ã€‚

### Lists/Tuples/Sets

ã™ã¹ã¦ã€`[ ]`ã§å›²ã¾ã‚ŒãŸä¸€é€£ã®å€¤ã§ã‚ã‚Šã€ä¸‹è¨˜ã®é•ã„ãŒã‚ã‚Šã¾ã™ã€‚

* `list`: è¦ç´ ãŒåŒã˜å‹ã§ã€é †åºã®ã‚ã‚‹é…åˆ—
    * ä¾‹: `["foo", "foo", "baz"]`
* `tuple`: è¦ç´ ãŒç•°ãªã‚‹å‹ã§ã€é †åºã®ã‚ã‚‹é…åˆ—
    * ä¾‹: `["foo", "foo", "baz", 1, true]`
* `set`: è¦ç´ ãŒåŒã˜å‹ã§ã€é †åºã®ãªã„é›†åˆï¼ˆé †åºãŒãªã„ãŸã‚ã€é‡è¤‡ãŒè¨±ã•ã‚Œãªã„ï¼‰
    * ä¾‹: `["foo", "bar", "baz"]`

### Maps/Objects

ã¨ã‚‚ã«ã€`{ }`ã§å›²ã¾ã‚ŒãŸä¸€é€£ã®key=valueã§ã‚ã‚Šã€ä¸‹è¨˜ã®é•ã„ãŒã‚ã‚Šã¾ã™ã€‚

* `map`: 1ã¤ã®å‹ã®valueã§ã®ã¿è¡¨ç¾å¯èƒ½
    * ãŸã ã—ã€å‹ã‚’ `map(string)`ã¨ã—ã¦ãŠã‘ã°ã€`number`ã‚„`bool`ã‚‚æš—é»™çš„ã«å‹å¤‰æ›ã•ã‚Œã‚‹ãŸã‚ã€å«ã‚ã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã™

ä¾‹:
```hcl
variable "map" {
  type        = map(string)
  description = "ã‚µãƒ³ãƒ—ãƒ«ãƒãƒƒãƒ—"
  default     = { a = "hoge", b = 1, c = true }
}
```

* `object`: è¤‡æ•°ã®å‹ã®valueã§è¡¨ç¾å¯èƒ½
    * keyã®åå‰ã¨valueã®å‹ã‚’å®šç¾©ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™

ä¾‹:
```hcl
variable "object" {
  type = object({
    a = list(string)
    b = number
    c = bool
  })
  description = "ã‚µãƒ³ãƒ—ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ"
  default = { a = ["hoge", "fuga"], b = 1, c = true }
}
```

### any ã«ã¤ã„ã¦ã®è£œè¶³
`map(any)`ãªã‚‰`object`ã®ã‚ˆã†ã«æ‰±ãˆã‚‹ã®ã§ã¯ï¼Ÿã¨æ€ã†æ–¹ã‚‚ã„ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
å®Ÿéš›ã«è©¦ã—ã¦ã‚‚ã‚‰ã£ãŸã‚‰åˆ†ã‹ã‚Šã¾ã™ãŒã€ã†ã¾ãã„ãã¾ã›ã‚“ã€‚

ãªãœãªã‚‰ã€å®Ÿã¯`any`ã¯**å˜ä¸€ã®å‹ã§ã®ã¿æ©Ÿèƒ½ã™ã‚‹ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰**ã ã‹ã‚‰ã§ã™ã€‚
â€¦ã§ã€å®Ÿéš›ã«è¤‡æ•°ã®ãƒ‡ãƒ¼ã‚¿å‹ãŒå…¥ã£ãŸå ´åˆã¯ã€ã‚„ã¯ã‚Šstringã«å¤‰æ›ã•ã‚Œã‚‹ãŸã‚ã€`map(any)`ã¯`map(string)`ã¨åŒã˜ã¨æ€ã£ã¦å·®ã—æ”¯ãˆãªã„ã¨æ€ã„ã¾ã™ã€‚
ï¼ˆãŸã ã—ã€å®Ÿéš›ã«è‰²ã€…ãªå‹ãŒå…¥ã‚‹ã¨æƒ³å®šã—ã¦ã„ã‚‹ã®ã§ã‚ã‚Œã°`map(any)`ã¨å®šç¾©ã—ã¦ãŠã„ãŸæ–¹ãŒã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®åˆ©ç”¨è€…ã‚„ä»–ã®é–‹ç™ºè€…ã«ã¨ã£ã¦è¦ªåˆ‡ã§ã™ã­ï¼‰

:::message
**å¿µã®ç‚ºã®è£œè¶³**
`map`ã®valueãŒé…åˆ—ã‚„é›†åˆãªã©ã«å¯¾å¿œã—ã¦ã„ãªã„ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
ãƒªã‚¹ãƒˆã®ãƒãƒƒãƒ—ï¼š`map(list(any))`ã‚„ãƒãƒƒãƒ—ã®ãƒãƒƒãƒ—ï¼š`map(map(any))`ã‚‚å½“ç„¶ä½œã‚Œã¾ã™ã€‚
ãŸã ã—ã€ã“ã®å ´åˆã€ãƒªã‚¹ãƒˆã®ãƒãƒƒãƒ—ã®valueã¯ã™ã¹ã¦`list(any)`ã§ãªã„ã¨ã„ã‘ãªã„ã—ã€ãƒãƒƒãƒ—ã®ãƒãƒƒãƒ—ã®valueã¯ã™ã¹ã¦`map(any)`ã§ãªã„ã¨ã„ã‘ãªã„ã¨ã„ã†ã“ã¨ã§ã™ã€‚
:::

### å‚è€ƒ
æœ¬ç« ã«é–¢ã™ã‚‹ã‚ˆã‚Šè©³ã—ã„å†…å®¹ã¯å…¬å¼ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚

https://developer.hashicorp.com/terraform/language/expressions/types
https://developer.hashicorp.com/terraform/language/expressions/type-constraints

## ãƒ«ãƒ¼ãƒ—å‡¦ç†
Terraformã®å‹ã«ã¤ã„ã¦æ•´ç†ã§ããŸã¨ã“ã‚ã§ã€æœ¬é¡Œã®ãƒ«ãƒ¼ãƒ—å‡¦ç†ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚

### for

`for`ã¯å¼ã§ã‚ã‚Šã€å…¥å‡ºåŠ›ãŒã‚ã‚Šã¾ã™ã€‚
* å…¥åŠ›ã¨ã—ã¦ã€`list`, `set`, `tuple`, `map`, `object`ã‚’å—ã‘ä»˜ã‘ã¾ã™
* å‡ºåŠ›ã¨ã—ã¦ã€`[ for ]`ã¯ `tuple` ã‚’ã€`{ for }`ã¯ `object` ã‚’è¿”ã—ã¾ã™
    * `[ ]`ã¨`{ }`ã¯å‰ç« ã§ç¢ºèªã—ãŸã¨ãŠã‚Šã§ã™ã­ã€‚

å…·ä½“ä¾‹ã¨ã—ã¦ã€ä¸‹è¨˜ã®ã‚ˆã†ãªlistãŒã‚ã£ãŸå ´åˆã€
```hcl
locals {
  list = ["foo", "bar", "baz"]
}
```
`tuple`ã®ç”Ÿæˆ
```sh
echo '[for s in local.list : upper(s)]' | terraform console
[
  "FOO",
  "BAR",
  "BAZ",
]
```
`object`ã®ç”Ÿæˆ
```sh
echo '{ for s in local.list : s => upper(s) }' | terraform console
{
  "bar" = "BAR"
  "baz" = "BAZ"
  "foo" = "FOO"
}
```
ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

`:`ã®å³è¾ºãŒå‡ºåŠ›ã§ã€keyã¨valueã‚’å‡ºåŠ›ã™ã‚‹å ´åˆã¯ã€`<OUTPUT_KEY> => <OUTPUT_VALUE>`ã®å½¢ã«ãªã‚Šã¾ã™ã€‚

æ­£ç›´ãªã¨ã“ã‚ã€`for`å˜ä½“ã§ã¯ã‚ã¾ã‚Šå‡ºç•ªãŒãªãã€æ¬¡ã«èª¬æ˜ã™ã‚‹`for_each`ã¨ã®çµ„ã¿åˆã‚ã›ã§ã‚ˆãä½¿ã„ã¾ã™ã€‚

#### å‚è€ƒ
https://developer.hashicorp.com/terraform/language/expressions/for


### for_each

`for_each`ã¯ãƒ¡ã‚¿å¼•æ•°ã¨å‘¼ã°ã‚Œã‚‹ã‚‚ã®ã§ã€`resource`ã‚„`module`ãƒ–ãƒ­ãƒƒã‚¯å†…ã§å®šç¾©ã§ãã¾ã™ã€‚
å®šç¾©ã™ã‚‹ã“ã¨ã§ã€`resource`ã‚„`module`ã®å‹•ä½œã‚’å¤‰æ›´ã§ãã¾ã™ã€‚
å…·ä½“çš„ã«ã¯ã€`for_each`ã‚’ä½¿ã†ã“ã¨ã§ã€1ã¤ã®`resource`ãƒ–ãƒ­ãƒƒã‚¯ã§ã€è¤‡æ•°ãƒªã‚½ãƒ¼ã‚¹ã®å®šç¾©ãŒå¯èƒ½ã¨ãªã‚Šã¾ã™ã€‚

```hcl
locals {
  name_list = ["hoge", "fuga"]
}
resource "aws_iam_user" "example" {
  for_each = toset(local.name_list)
  name     = each.value
}
```

terraform planå®Ÿè¡Œ
```
# aws_iam_user.example["fuga"] will be created
+ resource "aws_iam_user" "example" {
    + arn           = (known after apply)
    + force_destroy = false
    + id            = (known after apply)
    + name          = "fuga"
    + path          = "/"
    + tags_all      = (known after apply)
    + unique_id     = (known after apply)
  }
# aws_iam_user.example["hoge"] will be created
+ resource "aws_iam_user" "example" {
    + arn           = (known after apply)
    + force_destroy = false
    + id            = (known after apply)
    + name          = "hoge"
    + path          = "/"
    + tags_all      = (known after apply)
    + unique_id     = (known after apply)
  }
```

:::message
`for_each`ãŒå—ã‘å–ã‚Œã‚‹å‹ã¯`map`ã‹`set`ã§ã‚ã‚‹ãŸã‚ã€`toset()`ã‚’
ãŸã¨ãˆé‡è¤‡ãŒãªãã¦ã‚‚ã€local valueã®é…åˆ—ã¯`tuple`ã«ãªã‚Šã¾ã™ã€‚
:::

https://github.com/terraform-aws-modules/terraform-aws-vpc/blob/78f2845ee92364038780893e8d2107d692a163d3/main.tf#L1145-L1162

#### å‚è€ƒ
https://developer.hashicorp.com/terraform/language/meta-arguments/for_each

### count

countã¯ãƒ«ãƒ¼ãƒ—å‡¦ç†ã§ã®åˆ©ç”¨ã¯éæ¨å¥¨ã§ã™ã€‚å‰è¿°ã—ãŸ`for_each`ã‚’ä½¿ã„ã¾ã—ã‚‡ã†ã€‚
éæ¨å¥¨ãªç†ç”±ã¯ã€ä¸‹è¨˜ã®è¨˜äº‹ãŒå…·ä½“ä¾‹ã‚‚ã‚ã£ã¦ã€ç°¡æ½”ã§åˆ†ã‹ã‚Šã‚„ã™ã„ã§ã™ã€‚
https://tellme.tokyo/post/2022/06/12/terraform-count-for-each/
countã®ä½¿ã„æ‰€ã¯ã»ã¼ä¸€æŠã§ã€ãƒªã‚½ãƒ¼ã‚¹ä½œæˆã®ONãƒ»OFFã§ä½¿ç”¨ã—ã¾ã™ã€‚

## ã¾ã¨ã‚
é–“é•ã„ç­‰ã‚ã‚Œã°ã”æŒ‡æ‘˜ãŠé¡˜ã„ã—ã¾ã™ã€‚
ã¾ãŸã€æœ¬è¨˜äº‹ãŒå½¹ã«ç«‹ã¡ã¾ã—ãŸã‚‰ã€â™¡ã‚’ãƒãƒãƒƒã¨ãŠé¡˜ã„ã—ã¾ã™ã€‚
ä»¥ä¸Šã§ã™ã€‚