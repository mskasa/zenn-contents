---
title: "Terraformã®å‹ã¨ãƒ«ãƒ¼ãƒ—å‡¦ç† for_each = { for } ã«ã¤ã„ã¦ç†è§£ã™ã‚‹"
emoji: "ğŸŒ”"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [terraform,iac,aws,ã‚¤ãƒ³ãƒ•ãƒ©,ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°]
published: true
published_at: 2022-12-13 07:00
---

## æœ¬è¨˜äº‹ã®ç›®çš„
* Terraformã®å‹ã«ã¤ã„ã¦æ•´ç†ã™ã‚‹
* Terraformã®ãƒ«ãƒ¼ãƒ—å‡¦ç†`for_each = { for }`ã‚’ç†è§£ã™ã‚‹
* Terraformã®ãƒ«ãƒ¼ãƒ—å‡¦ç†ã®ä½¿ã„æ‰€ã€ä½¿ã„åˆ†ã‘ã«ã¤ã„ã¦ç†è§£ã™ã‚‹

## Terraformã®å‹ã«ã¤ã„ã¦

ãƒ«ãƒ¼ãƒ—å‡¦ç†ã®ç†è§£ã®ãŸã‚ã«ã¯ã€å‹ã®ç†è§£ãŒå¿…è¦ãªã®ã§ã€ã–ã£ãã‚Šã¨èª¬æ˜ã—ã¾ã™ã€‚
ã‚‚ã¡ã‚ã‚“ã€çŸ¥ã£ã¦ã„ã‚‹æ–¹ã¯èª­ã¿é£›ã°ã—ã¦ã‚‚ã‚‰ã£ã¦çµæ§‹ã§ã™ã€‚

### Lists/Tuples/Sets

ã™ã¹ã¦ã€`[ ]`ã§å›²ã¾ã‚ŒãŸä¸€é€£ã®å€¤ã§ã‚ã‚Šã€ä¸‹è¨˜ã®é•ã„ãŒã‚ã‚Šã¾ã™ã€‚

|  | è¦ç´ ã®å‹ | è¦ç´ ã®é †åº | ä¾‹ |
| ---- | ---- | ---- | ---- |
| `list` | åŒä¸€ | ã‚ã‚Š | `["foo", "foo", "baz"]` |
| `tuple` | ç•°ãªã‚‹å‹ã‚’è¨±å®¹ | ã‚ã‚Š | `["foo", "foo", "baz", 1, true]` |
| `set` | åŒä¸€ | ãªã—(é‡è¤‡ãŒè¨±ã•ã‚Œãªã„) | `["foo", "bar", "baz"]` |

### Maps/Objects

ã¨ã‚‚ã«ã€`{ }`ã§å›²ã¾ã‚ŒãŸä¸€é€£ã®key=valueã§ã‚ã‚Šã€ä¸‹è¨˜ã®é•ã„ãŒã‚ã‚Šã¾ã™ã€‚

* `map`: 1ã¤ã®å‹ã®valueã§ã®ã¿æ§‹æˆå¯èƒ½
    * ãŸã ã—ã€å‹ã‚’ `map(string)`ã¨ã—ã¦ãŠã‘ã°ã€æš—é»™çš„ã«å‹å¤‰æ›ã•ã‚Œã‚‹`number`ã‚„`bool`ã‚‚å«ã‚ã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã™

ä¾‹:
```hcl
variable "map" {
  type        = map(string)
  description = "ã‚µãƒ³ãƒ—ãƒ«ãƒãƒƒãƒ—"
  default     = { a = "hoge", b = 1, c = true }
}
```

* `object`: è¤‡æ•°ã®å‹ã®valueã§æ§‹æˆå¯èƒ½
    * keyã®åå‰ã¨valueã®å‹ã‚’å®šç¾©ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™

ä¾‹:
```hcl
variable "object" {
  type = object({
    a = list(string)
    b = number
    c = bool
  })
  description = "ã‚µãƒ³ãƒ—ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ"
  default = { a = ["hoge", "fuga"], b = 1, c = true }
}
```

### any ã«ã¤ã„ã¦ã®è£œè¶³
`map(any)`ãªã‚‰`object`ã®ã‚ˆã†ã«æ‰±ãˆã‚‹ã®ã§ã¯ï¼Ÿã¨æ€ã†æ–¹ã‚‚ã„ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
å®Ÿéš›ã«è©¦ã—ã¦ã‚‚ã‚‰ã£ãŸã‚‰åˆ†ã‹ã‚Šã¾ã™ãŒã€ã†ã¾ãã„ãã¾ã›ã‚“ã€‚

ãªãœãªã‚‰ã€å®Ÿã¯`any`ã¯**å˜ä¸€ã®å‹ã§ã®ã¿æ©Ÿèƒ½ã™ã‚‹ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰**ã ã‹ã‚‰ã§ã™ã€‚
â€¦ã§ã€å®Ÿéš›ã«è¤‡æ•°ã®ãƒ‡ãƒ¼ã‚¿å‹ãŒå…¥ã£ãŸå ´åˆã¯ã€ã‚„ã¯ã‚Šstringã«å¤‰æ›ã•ã‚Œã‚‹ãŸã‚ã€`map(any)`ã¯`map(string)`ã¨åŒã˜ã¨æ€ã£ã¦å·®ã—æ”¯ãˆãªã„ã¨æ€ã„ã¾ã™ã€‚
ãŸã ã—ã€å®Ÿéš›ã«è‰²ã€…ãªå‹ãŒå…¥ã‚‹ã¨æƒ³å®šã—ã¦ã„ã‚‹ã®ã§ã‚ã‚Œã°`map(any)`ã€æ–‡å­—åˆ—ã ã‘ãªã‚‰`map(string)`ã¨æ­£ã—ãå®šç¾©ã—ã¾ã—ã‚‡ã†ã€‚ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®åˆ©ç”¨è€…ã‚„ä»–ã®é–‹ç™ºè€…ã«æ­£ã—ã„æƒ…å ±ã‚’ä¼ãˆã‚‹ã“ã¨ãŒå¤§åˆ‡ã ã‹ã‚‰ã§ã™ã€‚

:::message
**å¿µã®ç‚ºã®è£œè¶³**
`map`ã®valueãŒé…åˆ—ã‚„é›†åˆãªã©ã«å¯¾å¿œã—ã¦ã„ãªã„ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
ãƒªã‚¹ãƒˆã®ãƒãƒƒãƒ—ï¼š`map(list(any))`ã‚„ãƒãƒƒãƒ—ã®ãƒãƒƒãƒ—ï¼š`map(map(any))`ã‚‚å½“ç„¶ä½œã‚Œã¾ã™ã€‚
ãŸã ã—ã€ã“ã®å ´åˆã€ãƒªã‚¹ãƒˆã®ãƒãƒƒãƒ—ã®valueã¯ã™ã¹ã¦`list(any)`ã§ãªã„ã¨ã„ã‘ãªã„ã—ã€ãƒãƒƒãƒ—ã®ãƒãƒƒãƒ—ã®valueã¯ã™ã¹ã¦`map(any)`ã§ãªã„ã¨ã„ã‘ãªã„ã¨ã„ã†ã“ã¨ã§ã™ã€‚
:::

### å‚è€ƒ
https://developer.hashicorp.com/terraform/language/expressions/types
https://developer.hashicorp.com/terraform/language/expressions/type-constraints

## ãƒ«ãƒ¼ãƒ—å‡¦ç†
Terraformã®å‹ã«ã¤ã„ã¦æ•´ç†ã§ããŸã¨ã“ã‚ã§ã€æœ¬é¡Œã®ãƒ«ãƒ¼ãƒ—å‡¦ç†ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚

### for

`for`ã¯å¼ã§ã‚ã‚Šã€å…¥å‡ºåŠ›ãŒã‚ã‚Šã¾ã™ã€‚
* å…¥åŠ›ã¨ã—ã¦ã€`list`, `set`, `tuple`, `map`, `object`ã‚’å—ã‘ä»˜ã‘ã¾ã™
* å‡ºåŠ›ã¨ã—ã¦ã€`[ for ]`ã¯ `tuple` ã‚’ã€`{ for }`ã¯ `object` ã‚’è¿”ã—ã¾ã™
    * `[ ]`ã¨`{ }`ã¯å‰ç« ã§å‹ã«ã¤ã„ã¦æ•´ç†ã—ãŸé€šã‚Šã§ã™ã­ã€‚

å…·ä½“ä¾‹ã¨ã—ã¦ã€ä¸‹è¨˜ã®ã‚ˆã†ãªlistãŒã‚ã£ãŸå ´åˆã€
```hcl
locals {
  list = ["foo", "bar", "baz"]
}
```
`tuple`ã®ç”Ÿæˆ
```sh
echo '[for s in local.list : upper(s)]' | terraform console
[
  "FOO",
  "BAR",
  "BAZ",
]
```
`object`ã®ç”Ÿæˆ
```sh
echo '{ for s in local.list : s => upper(s) }' | terraform console
{
  "bar" = "BAR"
  "baz" = "BAZ"
  "foo" = "FOO"
}
```
ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

`:`ã®å³è¾ºãŒå‡ºåŠ›ã§ã€keyã¨valueã‚’å‡ºåŠ›ã™ã‚‹å ´åˆã¯ã€`<OUTPUT_KEY> => <OUTPUT_VALUE>`ã®å½¢ã«ãªã‚Šã¾ã™ã€‚

æ­£ç›´ãªã¨ã“ã‚ã€`for`å˜ä½“ã§ã¯ã‚ã¾ã‚Šå‡ºç•ªãŒãªãã€æ¬¡ã«èª¬æ˜ã™ã‚‹`for_each`ã¨ã®çµ„ã¿åˆã‚ã›ã§ã‚ˆãä½¿ã„ã¾ã™ã€‚

#### å‚è€ƒ
https://developer.hashicorp.com/terraform/language/expressions/for


### for_each

`for_each`ã¯ãƒ¡ã‚¿å¼•æ•°ã¨å‘¼ã°ã‚Œã‚‹ã‚‚ã®ã§ã€`resource`ã‚„`module`ãƒ–ãƒ­ãƒƒã‚¯å†…ã§å®šç¾©ã§ãã¾ã™ã€‚
å®šç¾©ã™ã‚‹ã“ã¨ã§ã€`resource`ã‚„`module`ã®å‹•ä½œã‚’å¤‰æ›´ã§ãã¾ã™ã€‚
å…·ä½“çš„ã«ã¯ã€`for_each`ã‚’ä½¿ã†ã“ã¨ã§ã€1ã¤ã®`resource`ãƒ–ãƒ­ãƒƒã‚¯ã§ã€è¤‡æ•°ã®ãƒªã‚½ãƒ¼ã‚¹å®šç¾©ãŒå¯èƒ½ã¨ãªã‚Šã¾ã™ã€‚

`for_each`ãŒå—ã‘å–ã‚Œã‚‹å‹ã¯`set(string)`ã‹`map`ã§ã™ã€‚

#### set(string)ã‚’å…¥åŠ›ã¨ã—ãŸå ´åˆ

ä¾‹ï¼šIAMãƒ¦ãƒ¼ã‚¶ã‚’2ã¤ä½œæˆ
```hcl
locals {
  iam_user_names = toset(["hoge", "fuga"])
}
resource "aws_iam_user" "example" {
  for_each = local.iam_user_names
  name     = each.value
}
```

local valueã®é…åˆ—ã¯ã€é‡è¤‡ãŒãªãã¦ã‚‚`tuple`æ‰±ã„ã«ãªã‚‹ãŸã‚ã€`toset()`ã§å¤‰æ›ã—ã¦ã„ã¾ã™ã€‚
ãªãœã€`set(string)`ã§ãªã„ã¨ã„ã‘ãªã„ã®ã§ã—ã‚‡ã†ã‹ã€‚
`terraform plan`ã‚’å®Ÿè¡Œã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
```sh
# aws_iam_user.example["fuga"] will be created
+ resource "aws_iam_user" "example" {
    + arn           = (known after apply)
    + force_destroy = false
    + id            = (known after apply)
    + name          = "fuga"
    + path          = "/"
    + tags_all      = (known after apply)
    + unique_id     = (known after apply)
  }
# aws_iam_user.example["hoge"] will be created
+ resource "aws_iam_user" "example" {
    + arn           = (known after apply)
    + force_destroy = false
    + id            = (known after apply)
    + name          = "hoge"
    + path          = "/"
    + tags_all      = (known after apply)
    + unique_id     = (known after apply)
  }
```

æ³¨ç›®ã™ã¹ãç®‡æ‰€ã¯ãƒªã‚½ãƒ¼ã‚¹IDã§ã™ã€‚
* `aws_iam_user.example["fuga"]`
* `aws_iam_user.example["hoge"]`

é…åˆ—ã®å€¤ãŒãã®ã¾ã¾Terraformã®ãƒªã‚½ãƒ¼ã‚¹IDã«ãªã‚‹ãŸã‚ã€é‡è¤‡ãŒè¨±ã•ã‚Œãªã„`set(string)`ã—ã‹å—ã‘ä»˜ã‘ãªã„ã¨ã„ã†ã“ã¨ã§ã™ã€‚

`set(string)`ä»¥å¤–ã‚’æ¸¡ã™ã¨ã©ã†ãªã‚‹ã§ã—ã‚‡ã†ã€‚

ä¾‹ï¼šãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚µãƒ–ãƒãƒƒãƒˆã‚’2ã¤ä½œæˆ

```hcl
locals {
  vpc_cidr = "10.0.0.0/16"
  vpc_name = "example"
  public_subnets = toset([
    {
      az   = "ap-northeast-1a"
      name = "public"
      cidr = "10.0.1.0/24"
    },
    {
      az   = "ap-northeast-1c"
      name = "public"
      cidr = "10.0.2.0/24"
    }
  ])
}
resource "aws_vpc" "main" {
  cidr_block           = local.vpc_cidr
  enable_dns_support   = true
  enable_dns_hostnames = true

  tags = {
    Name = local.vpc_name
  }
}
resource "aws_subnet" "public" {
  for_each = local.public_subnets

  availability_zone       = each.value.az
  cidr_block              = each.value.cidr
  vpc_id                  = aws_vpc.main.id
  map_public_ip_on_launch = true

  tags = {
    Name = "${local.vpc_name}-${each.value.name}-${substr(each.value.az, -2, 0)}"
  }
}
```

`for_each = local.public_subnets`ã§ã€`set(object)`å‹ã®`local.public_subnets`ã‚’æ¸¡ã—ã¦ã„ã¾ã™ã€‚`terraform plan`ã‚’å®Ÿè¡Œã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```sh
Error: Invalid for_each set argument
The given "for_each" argument value is unsuitable: "for_each" supports maps and sets of strings, but you have provided a set containing type object.
```

å½“ç„¶ã€`set(object)`ã¯ãƒ€ãƒ¡ã ã‚ˆã¨æ€’ã‚‰ã‚Œã¾ã™ã€‚
`set(string)`ã ã‘ã ã¨ä½•ã‹ã¨ä¸ä¾¿ãã†ã§ã™ã­ã€‚ãã“ã§ã€`map`ã®å ´åˆã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

#### mapã‚’å…¥åŠ›ã¨ã—ãŸå ´åˆ

å…ˆç¨‹ã®ä¾‹ã®`public_subnets`ã‚’`map`ã«ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
```hcl
locals {
  public_subnets = {
    0 = {
      az   = "ap-northeast-1a"
      name = "public"
      cidr = "10.0.1.0/24"
    }
    1 = {
      az   = "ap-northeast-1c"
      name = "public"
      cidr = "10.0.2.0/24"
    }
  }
}
```

`terraform plan`ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€æœŸå¾…ã™ã‚‹çµæœãŒå¾—ã‚‰ã‚ŒãŸã¨æ€ã„ã¾ã™ã€‚
ã—ã‹ã—ã€ãƒãƒƒãƒ—ã®keyã‚’ç›´æ›¸ãã™ã‚‹ã‚ˆã‚Šã‚‚ã€ã§ãã‚Œã°ã€ä¸‹è¨˜ã®ã‚ˆã†ã«ç›´æ„Ÿçš„ã«æ›¸ããŸã„ã‚‚ã®ã§ã™ã€‚

```hcl
locals {
  public_subnets = [
    {
      az   = "ap-northeast-1a"
      name = "public"
      cidr = "10.0.1.0/24"
    },
    {
      az   = "ap-northeast-1c"
      name = "public"
      cidr = "10.0.2.0/24"
    }
  ]
}
```

ãã“ã§ã€`{ for }`ã®å‡ºç•ªã§ã™ã€‚`{ for }`ã¯ `object` ã‚’è¿”ã—ã€`object`ã¯æš—é»™çš„ã«`map`ã«å¤‰æ›ã•ã‚Œã¾ã™ã€‚ã¤ã¾ã‚Šã€ä¸‹è¨˜ã®ã‚ˆã†ã«æ›¸ã‘ã‚‹ã‚ã‘ã§ã™ã€‚

```diff hcl
locals {
  vpc_cidr = "10.0.0.0/16"
  vpc_name = "example"
  public_subnets = [
    {
      az   = "ap-northeast-1a"
      name = "public"
      cidr = "10.0.1.0/24"
    },
    {
      az   = "ap-northeast-1c"
      name = "public"
      cidr = "10.0.2.0/24"
    }
  ]
}
resource "aws_vpc" "main" {
  cidr_block           = local.vpc_cidr
  enable_dns_support   = true
  enable_dns_hostnames = true

  tags = {
    Name = local.vpc_name
  }
}
resource "aws_subnet" "public" {
+ for_each = { for i in local.public_subnets : i.az => i }
- for_each = local.public_subnets

  availability_zone       = each.value.az
  cidr_block              = each.value.cidr
  vpc_id                  = aws_vpc.main.id
  map_public_ip_on_launch = true

  tags = {
    Name = "${local.vpc_name}-${each.value.name}-${substr(each.value.az, -2, 0)}"
  }
}
```

å†åº¦èª¬æ˜ã™ã‚‹ã¨ã€`i.az => i`ã®éƒ¨åˆ†ã¯`local.public_subnets`ã®`az`ã‚’keyã«ã—ã¦ã€`object`ã®valueã¨ç´ä»˜ã‘ã¦ã„ã‚‹ã®ã§ã—ãŸã­ã€‚ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```sh
echo '{ for i in local.public_subnets : i.az => i }' | terraform console
{
  "ap-northeast-1a" = {
    "az" = "ap-northeast-1a"
    "cidr" = "10.0.1.0/24"
    "name" = "public"
  }
  "ap-northeast-1c" = {
    "az" = "ap-northeast-1c"
    "cidr" = "10.0.2.0/24"
    "name" = "public"
  }
}
```

ãã—ã¦ã€`for_each`ã§ä½œæˆã—ãŸãƒªã‚½ãƒ¼ã‚¹ã®å€¤ã‚’outputã—ãŸã„å ´åˆã¯ã€`[ for ]`ã‚’ä½¿ã„ã¾ã™ã€‚

```hcl
output "public_subnet_ids" {
  description = "Public Subnet IDs"
  value       = [for value in aws_subnet.public : value.id]
}
```

ã“ã®`for_each = { for }`ã®å½¢ã¯Terraformã®ã‚½ãƒ¼ã‚¹ã§é »ç¹ã«ç¾ã‚Œã‚‹ã®ã§ã€ãœã²ä»•çµ„ã¿ã‚’ç†è§£ã—ã¦ãŠããŸã„ã§ã™ã­ã€‚

#### å¿œç”¨
ä¸‹è¨˜ã®ã‚ˆã†ã«`if`ã§æ¡ä»¶ã‚’è¿½åŠ ã§ãã¾ã™ã€‚
https://github.com/terraform-aws-modules/terraform-aws-rds-aurora/blob/master/main.tf#L226-L236

ä¸‰é …æ¼”ç®—å­ã¨çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚
https://github.com/terraform-aws-modules/terraform-aws-cloudfront/blob/master/main.tf#L5-L13

ã¾ãŸã€`for_each`ã¯`dynamic`ã¨ã®çµ„ã¿åˆã‚ã›ã§ã‚‚é »å‡ºã§ã™ã€‚æ©Ÿä¼šãŒã‚ã‚Œã°ã€`dynamic`ã®ä½¿ã„æ–¹ã«ã¤ã„ã¦ã‚‚ã¾ã¨ã‚ã‚ˆã†ã‹ã¨æ€ã„ã¾ã™ã€‚

#### å‚è€ƒ
https://developer.hashicorp.com/terraform/language/meta-arguments/for_each

### count

æœ€å¾Œã«`count`ã§ã™ãŒã€`count`ã¯ãƒ«ãƒ¼ãƒ—å‡¦ç†ã§ã®åˆ©ç”¨ã¯éæ¨å¥¨ã§ã™ã€‚`for_each`ã‚’ä½¿ã„ã¾ã—ã‚‡ã†ã€‚
éæ¨å¥¨ãªç†ç”±ã¯ã€ä¸‹è¨˜ã®è¨˜äº‹ãŒå…·ä½“ä¾‹ã‚‚ã‚ã£ã¦ã€ç°¡æ½”ã§åˆ†ã‹ã‚Šã‚„ã™ã„ã§ã™ã€‚
https://tellme.tokyo/post/2022/06/12/terraform-count-for-each/

`count`ã®ä½¿ã„æ‰€ã¯ã»ã¼ä¸€æŠã§ã€ãƒªã‚½ãƒ¼ã‚¹ä½œæˆã®ONãƒ»OFFã§ä½¿ç”¨ã—ã¾ã™ã€‚

https://github.com/terraform-aws-modules/terraform-aws-s3-bucket/blob/master/main.tf#L18-L27

## ã¾ã¨ã‚
ä»Šå›ã¯Terraformã‚’DRYã«æ›¸ããŸã‚ã«å¿…é ˆã§ã‚ã‚‹ãƒ«ãƒ¼ãƒ—å‡¦ç†ã‚’ç´è§£ã„ã¦ã¿ã¾ã—ãŸã€‚
ã‚‚ã—ã€å½¹ã«ç«‹ã£ãŸéƒ¨åˆ†ãŒã‚ã‚Œã°ã€â™¡ã‚’ãƒãƒãƒƒã¨ãŠé¡˜ã„ã—ã¾ã™ã€‚

ã¾ãŸã€é–“é•ã„ç­‰ã‚ã‚Œã°ã”æŒ‡æ‘˜ãŠé¡˜ã„ã—ã¾ã™ã€‚
ä»¥ä¸Šã§ã™ã€‚