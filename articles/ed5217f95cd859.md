---
title: "AWS Lambdaã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã§CI/CD"
emoji: "ğŸ¦ˆ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [aws, lambda, cicd, shell]
published: false
---

## æ¦‚è¦

å…ˆæ—¥ã€GitLabã§ç®¡ç†ã•ã‚Œã¦ã„ã‚‹Lambdaé–¢æ•°ã®CI/CDæ§‹ç¯‰ã«æºã‚ã‚Šã€ã„ãã¤ã‹èº“ãç‚¹ãŒã‚ã‚Šã¾ã—ãŸã€‚
å‚™å¿˜éŒ²çš„ã§ã¯ã‚ã‚Šã¾ã™ãŒã€èª°ã‹ã®å½¹ã«ç«‹ã¦ã°ã¨æ€ã£ã¦æ›¸ãè¨˜ã—ã¦ãŠãã¾ã™ã€‚
ãªãŠã€ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã¯Javaã§ã™ãŒã€æœ¬ç­‹ã‹ã‚‰é€¸ã‚Œã‚‹ã®ã§ã€jarã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆã‚½ãƒ¼ã‚¹ã®ãƒ‡ãƒ—ãƒ­ã‚¤éƒ¨åˆ†ï¼‰ã«ã¤ã„ã¦ã¯å‰²æ„›ã—ã¾ã™ã€‚

## CI/CDæ§‹æˆ

### CI/CDæ§‹æˆå›³

### ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ä¸€è¦§

## çµè«–

```yaml:.gitlab-ci.yaml
stages:
  - dev_deploy
dev_deploy:
  stage: dev_deploy
  when: manual
  image: registry.gitlab.com/gitlab-org/cloud-deploy/aws-base:latest
  script:
    - source ./cicd/oidc-aws.sh
    - ./cicd/deploy.sh dev
  only:
    refs:
      - master
```

å‡¦ç†å˜ä½ã§ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆã™ã‚‹ã®ã§ã€yamlã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ãªã‚Šã¾ã™ã€‚

```bash:oidc-aws.sh
#!/bin/bash

STS=($(aws sts assume-role-with-web-identity \
  --role-arn ${ROLE_ARN} \
  --role-session-name "GitLabRunner-${CI_PROJECT_ID}-${CI_PIPELINE_ID}" \
  --web-identity-token $CI_JOB_JWT_V2 \
  --duration-seconds 3600 \
  --query 'Credentials.[AccessKeyId,SecretAccessKey,SessionToken]' \
  --output text))

export AWS_ACCESS_KEY_ID="${STS[0]}"
export AWS_SECRET_ACCESS_KEY="${STS[1]}"
export AWS_SESSION_TOKEN="${STS[2]}"
```

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "",
            "Effect": "Allow",
            "Principal": {
                "Federated": "arn:aws:iam::<YOUR_ACCOUNT_ID>:oidc-provider/gitlab.com"
            },
            "Action": "sts:AssumeRoleWithWebIdentity",
            "Condition": {
                "StringLike": {
                    "gitlab.com:sub": "project_path:xxx/yyy/*:ref_type:branch:ref:*"
                }
            }
        }
    ]
}
```

:::message
ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ã‚’ä½¿ã†å ´åˆã¯ã€`StringEquals`ã§ã¯ãªã`StringLike`ã«ãªã‚Šã¾ã™ã€‚
:::

`An error occurred (ResourceConflictException) when calling the PublishVersion operation: The operation cannot be performed at this time. An update is in progress for resource: arn:aws:lambda:ap-northeast-1:xxx:function:xxx`

```sh
./deploy.sh dev
```

```sh
function_name=xxx
# ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã™ã‚‹
aws lambda update-function-configuration \
  --function-name $function_name \
  --environment Variables={ENV=$1}
# LastUpdateStatusãŒInProgressã®å ´åˆã€å¾Œç¶šã®ã‚³ãƒãƒ³ãƒ‰ãŒå¤±æ•—ã™ã‚‹ãŸã‚ã€Successfulã«ãªã‚‹ã¾ã§å¾…æ©Ÿã™ã‚‹
while [ "$last_update_status" != "\"Successful\"" ]
do
  last_update_status=$(aws lambda get-function --function-name $function_name --query 'Configuration.LastUpdateStatus')
done
# ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç™ºè¡Œã—ã€ç™ºè¡Œã—ãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—ã™ã‚‹
function_version=$(aws lambda publish-version \
  --function-name $function_name \
  --query Version \
  --output text)
# ä»˜ä¸ã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹ã‚¨ã‚¤ãƒªã‚¢ã‚¹ãŒæ—¢ã«ã‚ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã™ã‚‹
aws lambda get-alias \
  --function-name $function_name \
  --name $1
result_get_alias=$?
# ç™ºè¡Œã—ãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«å¯¾ã—ã¦ã€ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’è¨­å®šã™ã‚‹
# ä»˜ä¸ã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹ã‚¨ã‚¤ãƒªã‚¢ã‚¹ãŒæ—¢ã«ã‚ã‚‹å ´åˆã€æ›´æ–°ã™ã‚‹
if [[ $result_get_alias == 0 ]] ; then
  aws lambda update-alias \
    --function-name $function_name \
    --name $1 \
    --function-version $function_version
# ä»˜ä¸ã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹ã‚¨ã‚¤ãƒªã‚¢ã‚¹ãŒãªã„å ´åˆã€ä½œæˆã™ã‚‹
else
  aws lambda create-alias \
    --function-name $function_name \
    --name $1 \
    --function-version $function_version
fi
```

https://docs.aws.amazon.com/cli/latest/reference/lambda/update-function-configuration.html

https://docs.aws.amazon.com/cli/latest/reference/lambda/get-function.html

https://docs.aws.amazon.com/cli/latest/reference/lambda/publish-version.html

https://docs.aws.amazon.com/cli/latest/reference/lambda/get-alias.html

https://docs.aws.amazon.com/cli/latest/reference/lambda/create-alias.html

https://docs.aws.amazon.com/cli/latest/reference/lambda/update-alias.html