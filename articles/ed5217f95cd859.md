---
title: "AWS Lambdaã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã§CI/CD"
emoji: "ğŸ¦ˆ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [aws, lambda, cicd, shell]
published: false
---

## æ¦‚è¦


`An error occurred (ResourceConflictException) when calling the PublishVersion operation: The operation cannot be performed at this time. An update is in progress for resource: arn:aws:lambda:ap-northeast-1:xxx:function:xxx`

```sh
./deploy.sh dev
```

```sh
function_name=xxx
# ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã™ã‚‹
aws lambda update-function-configuration \
  --function-name $function_name \
  --environment Variables={ENV=$1}
# LastUpdateStatusãŒInProgressã®å ´åˆã€å¾Œç¶šã®ã‚³ãƒãƒ³ãƒ‰ãŒå¤±æ•—ã™ã‚‹ãŸã‚ã€Successfulã«ãªã‚‹ã¾ã§å¾…æ©Ÿã™ã‚‹
while [ "$last_update_status" != "\"Successful\"" ]
do
  last_update_status=$(aws lambda get-function --function-name $function_name --query 'Configuration.LastUpdateStatus')
done
# ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç™ºè¡Œã—ã€ç™ºè¡Œã—ãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—ã™ã‚‹
function_version=$(aws lambda publish-version \
  --function-name $function_name \
  --query Version \
  --output text)
# ä»˜ä¸ã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹ã‚¨ã‚¤ãƒªã‚¢ã‚¹ãŒæ—¢ã«ã‚ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã™ã‚‹
aws lambda get-alias \
  --function-name $function_name \
  --name $1
result_get_alias=$?
# ç™ºè¡Œã—ãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«å¯¾ã—ã¦ã€ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’è¨­å®šã™ã‚‹
# ä»˜ä¸ã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹ã‚¨ã‚¤ãƒªã‚¢ã‚¹ãŒæ—¢ã«ã‚ã‚‹å ´åˆã€æ›´æ–°ã™ã‚‹
if [[ $result_get_alias == 0 ]] ; then
  aws lambda update-alias \
    --function-name $function_name \
    --name $1 \
    --function-version $function_version
# ä»˜ä¸ã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹ã‚¨ã‚¤ãƒªã‚¢ã‚¹ãŒãªã„å ´åˆã€ä½œæˆã™ã‚‹
else
  aws lambda create-alias \
    --function-name $function_name \
    --name $1 \
    --function-version $function_version
fi
```